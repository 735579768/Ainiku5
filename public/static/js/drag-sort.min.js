!function(t){function s(){this._ts=this,this.pthis=null,this.data={conf:"",divspace:"",mousedown:!1,_x:0,_y:0,dragobj:null},this.toDivSpace=function(t){t.removeClass("temitem"),t.addClass("divspace"),t.addClass("todivspace")},this.toTemItem=function(){this.pthis.find(".todivspace").each(function(s,i){t(this).addClass("temitem"),t(this).removeClass("divspace"),t(this).removeClass("todivspace")})},this.removeSpace=function(){this.pthis.find(".divspace").remove()},this.getobj=function(s,i){var e={o:null,insert:"before",status:0},a=null;return this.pthis.find(s).each(function(s,d){cury=i.y,curx=i.x,curdragid=i.dragid;var o=t(this).offset().top,n=t(this).offset().left,c=t(this).outerWidth(),r=t(this).outerHeight(),p=t(this).attr("dragid");return absy=Math.abs(cury-o),absx=Math.abs(curx-n),bo=cury!==o&&curx!==n&&absy<r/2&&absx<c/2&&curdragid!==p,bo?o<cury?(a=s,e.status=1,!1):(a=s,e.status=1,e.insert="after",!1):void 0}),null==a?e:(e.o=this.pthis.find(s).eq(a),e)},this.init=function(){var s=this,i=this.data,e=this.pthis,a=s.data.conf;e.css("position","relative"),a.dragitem=a.dragitem+",.temitem,.todivspace",e.bind("mouseup",function(t){i.mousedown=!1}),e.bind("mousemove",function(t){if(i.mousedown&&null!=i.dragobj){var d=i.dragobj,o=e.offset().left,n=e.offset().top,c=t.pageX-i._x-o,r=t.pageY-i._y-n;d.css({zIndex:1e3,position:"absolute",left:c+"px",top:r+"px",paddingLeft:d.css("paddingLeft"),paddingTop:d.css("paddingTop"),paddingRight:d.css("paddingRight"),paddingBottom:d.css("paddingBottom"),width:d.css("width"),height:d.css("height")});var p={y:r+n,x:c+o,h:d.outerHeight(),w:d.outerWidth(),dragid:d.attr("dragid")},f=s.getobj(a.dragitem,p);1===f.status?f.o.hasClass("temitem")||f.o.hasClass("todivspace")?s.toDivSpace(f.o):"after"===f.insert?(s.toTemItem(),s.removeSpace(),f.o.after(i.divspace)):(s.toTemItem(),s.removeSpace(),f.o.before(i.divspace)):s.toTemItem()}}),e.find(a.dragitem).each(function(d,o){var n=t(this);n.attr("dragid",d),n.bind("mousedown",function(d){var o=t(this);i.mousedown=!0,i.dragobj=o;var n=o.offset().left,c=o.offset().top;i._x=d.pageX-n,i._y=d.pageY-c,s.removeSpace(),i.divspace='<div class="divspace" style="margin:'+o.css("margin")+";width:"+(o.outerWidth()-2)+"px;height:"+(o.outerHeight()-2)+"px;border:dashed 1px #f00;"+a.spacestyle+'"></div>',o.before(i.divspace),e.find(".divspace").css("marginLeft",o.css("marginLeft")),e.find(".divspace").css("marginRight",o.css("marginRight")),e.find(".divspace").css("marginTop",o.css("marginTop")),e.find(".divspace").css("marginBottom",o.css("marginBottom")),i.divspace='<div class="divspace" style="'+t(".divspace").eq(0).attr("style")+'"></div>',o.css("cursor","move"),o.css({zIndex:1e3,position:"absolute",left:n-e.offset().left+"px",top:c-e.offset().top+"px",paddingLeft:o.css("paddingLeft"),paddingTop:o.css("paddingTop"),paddingRight:o.css("paddingRight"),paddingBottom:o.css("paddingBottom"),width:o.css("width"),height:o.css("height")}),""!=a.draggroup&&(dragitem=o,e.find(a.draggroup).each(function(s,e){var d=t(this);if(0===d.find(a.dragitem).length){d.append(i.divspace);var o=d.find(".divspace");o.removeClass("divspace"),o.addClass("temitem"),o.attr("dragid",99999+s)}}))}),n.bind("mouseup",function(){var s=t(this);i.mousedown=!1,i.lock=null;var d="";d=e.find(".todivspace").length>0?".todivspace":".divspace";var o=e.find(d),n=(o.offset().top||0)-e.offset().top,c=o.offset().left-e.offset().left;s.animate({left:c,top:n},100,function(){o.before(s),s.removeAttr("style"),e.find(".divspace,.temitem").remove(),"function"==typeof a.success&&a.success(e)})})})}}t.fn.kldrag=function(i){this.each(function(e,a){var d=new s,o={spacestyle:"",dragitem:".dragitem",draggroup:"",success:function(){}},n=t.extend(o,i);d.data.conf=n,d.pthis=t(this),d.init()})}}(jQuery);