function UPLOADFILE(){this.fileInput=null,this.uploadInput=null,this.dragDrop=null,this.url="",this.data={},this.uploadFile=[],this.lastUploadFile=[],this.perUploadFile=[],this.fileNum=0,this.filterFile=function(e){return e},this.onSelect=function(e,i){},this.onDelete=function(e,i){},this.onProgress=function(e,i,t){},this.onSuccess=function(e,i){},this.onFailure=function(e,i){},this.onComplete=function(e){},this.funDragHover=function(e){return e.stopPropagation(),e.preventDefault(),this["dragover"===e.type?"onDragOver":"onDragLeave"].call(e.target),this},this.funGetFiles=function(e){var i=this;this.funDragHover(e);var t=e.target.files||e.dataTransfer.files;i.lastUploadFile=this.uploadFile,this.uploadFile=this.uploadFile.concat(this.filterFile(t));var a=[],n=[],l=[];return $.each(i.lastUploadFile,function(e,i){n.push(i.name)}),$.each(i.uploadFile,function(e,i){l.push(i.name)}),$.each(l,function(e,t){$.inArray(t,n)<0&&a.push(i.uploadFile[e])}),this.uploadFile=a,this.funDealtFiles(),!0},this.funDealtFiles=function(){var e=this;$.each(this.uploadFile,function(i,t){t.index=e.fileNum,e.fileNum++});var i=this.uploadFile;return this.perUploadFile=this.perUploadFile.concat(this.uploadFile),this.uploadFile=this.lastUploadFile.concat(this.uploadFile),this.onSelect(i,this.uploadFile),this},this.funDeleteFile=function(e,i){var t=this,a=[],n=this.perUploadFile[e];return $.each(this.uploadFile,function(e,i){n!=i&&a.push(i)}),this.uploadFile=a,i&&t.onDelete(n,this.uploadFile),!0},this.funUploadFiles=function(){var e=this;$.each(this.uploadFile,function(i,t){e.funUploadFile(t)})},this.funUploadFile=function(e){var i=this,t=new FormData;t.append("filelist",e);var a=this.data;for(var n in a)t.append(n,a[n]);var l=new XMLHttpRequest;l.upload.addEventListener("progress",function(t){i.onProgress(e,t.loaded,t.total)},!1),l.addEventListener("load",function(t){i.funDeleteFile(e.index,!1),i.onSuccess(e,l.responseText),0==i.uploadFile.length&&i.onComplete("全部完成")},!1),l.addEventListener("error",function(t){i.onFailure(e,l.responseText)},!1),l.open("POST",i.url,!0),l.setRequestHeader("X_FILENAME",encodeURIComponent(e.name)),l.send(t)},this.funReturnNeedFiles=function(){return this.uploadFile},this.init=function(){var e=this;this.dragDrop&&(this.dragDrop.addEventListener("dragover",function(i){e.funDragHover(i)},!1),this.dragDrop.addEventListener("dragleave",function(i){e.funDragHover(i)},!1),this.dragDrop.addEventListener("drop",function(i){e.funGetFiles(i)},!1)),e.fileInput&&this.fileInput.addEventListener("change",function(i){e.funGetFiles(i)},!1),e.uploadInput&&this.uploadInput.addEventListener("click",function(i){e.funUploadFiles(i)},!1)}}!function(e,i){e.fn.zyUpload=function(i,t){var a=Array.prototype.slice.call(arguments,1);if("string"==typeof i){var n=this[0][i];if(e.isFunction(n))return n.apply(this,a);throw"zyUpload - No such method: "+i}return this.each(function(){var t={},a=this,n={data:{},width:"700px",height:"400px",itemWidth:"140px",itemHeight:"120px",url:"/upload/UploadAction",multiple:!0,dragDrop:!0,del:!0,finishDel:!1,onSelect:function(e,i){},onDelete:function(e,i){},onSuccess:function(e){},onFailure:function(e){},onComplete:function(e){}};t=e.extend(n,i),this.init=function(){this.createHtml(),this.createCorePlug()},this.createHtml=function(){var i="";i=t.multiple?"multiple":"";var n="";if(t.dragDrop)n+='<form class="uploadForm" action="'+t.url+'" method="post" enctype="multipart/form-data">',n+='	<div class="upload_box">',n+='		<div class="upload_main">',n+='			<div class="upload_choose">',n+='				<div class="convent_choice">',n+='					<div class="andArea">',n+='						<div class="filePicker"><b class="addimg">+</b>添加文件</div>',n+='						<input   class="fileImage"  type="file" size="30" name="fileselect[]" '+i+">",n+="					</div>",n+="				</div>",n+='				<span  class="fileDragArea upload_drag_area">或者将文件拖到此处</span>',n+="			</div>",n+='			<div class="status_bar">',n+='				<div  class="info status_info">选中0张，共0B。</div>',n+='				<div class="btns">',n+='					<div class="webuploader_pick">继续选择</div>',n+='					<div class="upload_btn">开始上传</div>',n+="				</div>",n+="			</div>",n+='			<div  class="preview upload_preview"></div>',n+="		</div>",n+='		<div class="upload_submit">',n+='			<button type="button"  class="fileSubmit upload_submit_btn">确认上传文件</button>',n+="		</div>",n+='		<div id="uploadInf" class="upload_inf"></div>',n+="	</div>",n+="</form>";else{var l=parseInt(t.itemWidth.replace("px",""))-15;n+='<form class="uploadForm" action="'+t.url+'" method="post" enctype="multipart/form-data">',n+='	<div class="upload_box">',n+='		<div class="upload_main single_main">',n+='			<div class="status_bar">',n+='				<div class="info status_info">选中0张，共0B。</div>',n+='				<div class="btns">',n+='					<input class="fileImage" type="file" size="30" name="fileselect[]" '+i+">",n+='					<div class="webuploader_pick">选择文件</div>',n+='					<div class="upload_btn">开始上传</div>',n+="				</div>",n+="			</div>",n+='			<div  class="preview upload_preview">',n+='				<div class="add_upload">',n+='					<a style="height:'+t.itemHeight+";width:"+t.itemWidth+';" title="点击添加文件" id="" class="rapidAddImg    add_imgBox" href="javascript:void(0)">',n+='						<div class="uploadImg" style="width:'+l+'px">',n+='							<img class="upload_image" src="/Public/Static/html5Upload/images/add_img.png" style="width:expression(this.width > '+l+" ? "+l+'px : this.width)" />',n+="						</div>",n+="					</a>",n+="				</div>",n+="			</div>",n+="		</div>",n+='		<div class="upload_submit">',n+='			<button type="button"  class="fileSubmit upload_submit_btn">确认上传文件</button>',n+="		</div>",n+='		<div id="uploadInf" class="upload_inf"></div>',n+="	</div>",n+="</form>"}e(a).append(n).css({width:t.width,height:t.height}),this.addEvent()},this.funSetStatusInfo=function(i){var a=0,n=i.length;e.each(i,function(e,i){a+=i.size}),a=a>1048576?(Math.round(100*a/1048576)/100).toString()+"MB":(Math.round(100*a/1024)/100).toString()+"KB",e(t.parentsel+" .status_info").html("选中"+n+"张，共"+a+"。")},this.funFilterEligibleFile=function(e){for(var i,t=[],a=0;i=e[a];a++)i.size>=512e6?alert('您这个"'+i.name+'"文件大小过大'):t.push(i);return t},this.funDisposePreviewHtml=function(e,i){var a="",n=parseInt(t.itemWidth.replace("px",""))-15,l="";t.del&&(l='<span class="file_del" data-index="'+e.index+'" title="删除"></span>');var s="/Public/Static/html5Upload/images/fileType/";return s+=e.name.indexOf(".rar")>0?"rar.png":e.name.indexOf(".zip")>0?"zip.png":e.name.indexOf(".text")>0?"txt.png":e.name.indexOf(".mp4")>0?"video.png":"other.png",0==e.type.indexOf("image")?(a+='<div  class="uploadList_'+e.index+'  upload_append_list">',a+='	<div class="file_bar">',a+='		<div style="padding:5px;">',a+='			<p class="file_name">'+e.name+"</p>",a+=l,a+="		</div>",a+="	</div>",a+='	<a style="height:'+t.itemHeight+";width:"+t.itemWidth+';" href="javascript:;" class="imgBox">',a+='		<div class="uploadImg" style="width:'+n+'px">',a+='			<img id="uploadImage_'+e.index+'" class="upload_image" src="'+i.target.result+'" style="width:expression(this.width > '+n+" ? "+n+'px : this.width)" />',a+="		</div>",a+="	</a>",a+='	<p class="uploadProgress_'+e.index+' file_progress"></p>',a+='	<p id="uploadFailure_'+e.index+'" class="file_failure">上传失败，请重试</p>',a+='	<p id="uploadSuccess_'+e.index+'" class="file_success"></p>',a+="</div>"):(a+='<div  class="uploadList_'+e.index+'  upload_append_list">',a+='	<div class="file_bar">',a+='		<div style="padding:5px;">',a+='			<p class="file_name">'+e.name+"</p>",a+=l,a+="		</div>",a+="	</div>",a+='	<a style="height:'+t.itemHeight+";width:"+t.itemWidth+';" href="javascript:;" class="imgBox">',a+='		<div class="uploadImg" style="width:'+n+'px">',a+='			<img id="uploadImage_'+e.index+'" class="upload_image" src="'+s+'" style="width:expression(this.width > '+n+" ? "+n+'px : this.width)" />',a+="		</div>",a+="	</a>",a+='	<p class="uploadProgress_'+e.index+' file_progress"></p>',a+='	<p id="uploadFailure_'+e.index+'" class="file_failure">上传失败，请重试</p>',a+='	<p id="uploadSuccess_'+e.index+'" class="file_success"></p>',a+="</div>"),a},this.createCorePlug=function(){var i={data:t.data,fileInput:e(t.parentsel+" .fileImage").get(0),uploadInput:e(t.parentsel+" .fileSubmit").get(0),dragDrop:e(t.parentsel+" .fileDragArea").get(0),url:e(t.parentsel+" .uploadForm").attr("action"),filterFile:function(e){return a.funFilterEligibleFile(e)},onSelect:function(i,n){t.onSelect(i,n),a.funSetStatusInfo(a.ZYFILE.funReturnNeedFiles());var l="",s=0,d=function(){var e=i[s];if(e){var t=new FileReader;t.onload=function(i){l+=a.funDisposePreviewHtml(e,i),s++,d()},t.readAsDataURL(e)}else o(l)},o=function(i){t.dragDrop?e(t.parentsel+" .preview").append(i):e(t.parentsel+" .add_upload").before(i),r(),u()},r=function(){e(t.parentsel+" .file_del").length>0&&e(t.parentsel+" .file_del").click(function(){return a.ZYFILE.funDeleteFile(parseInt(e(this).attr("data-index")),!0),!1}),e(t.parentsel+" .file_edit").length>0&&e(t.parentsel+" .file_edit").click(function(){return!1})},u=function(){e(t.parentsel+" .upload_append_list").hover(function(i){e(this).find(".file_bar").addClass("file_hover")},function(i){e(this).find(".file_bar").removeClass("file_hover")})};d()},onDelete:function(i,n){e(t.parentsel+"  .uploadList_"+i.index).fadeOut(),a.funSetStatusInfo(n)},onProgress:function(i,a,n){var l=e(t.parentsel+"  .uploadProgress_"+i.index),s=(a/n*100).toFixed(2)+"%";l.is(":hidden")&&l.show(),l.css("width",s),l.html(s)},onSuccess:function(i,n){t.onSuccess(i,n),t.finishDel&&(e(t.parentsel+"  .uploadList_"+i.index).fadeOut(),a.funSetStatusInfo(a.ZYFILE.funReturnNeedFiles()))},onFailure:function(e){t.onFailure(e)},onComplete:function(e){t.onComplete(e)},onDragOver:function(){e(this).addClass("upload_drag_hover")},onDragLeave:function(){e(this).removeClass("upload_drag_hover")}};a.ZYFILE=null,a.ZYFILE=e.extend(new UPLOADFILE,i),a.ZYFILE.init()},this.addEvent=function(){e(t.parentsel+" .filePicker").length>0&&e(t.parentsel+" .filePicker").bind("click",function(i){e(t.parentsel+" .fileImage").click()}),e(t.parentsel+"   .webuploader_pick").bind("click",function(i){e(t.parentsel+" .fileImage").click()}),e(t.parentsel+"   .upload_btn").bind("click",function(i){a.ZYFILE.funReturnNeedFiles().length>0?e(t.parentsel+" .fileSubmit").click():alert("请先选中文件再点击上传")}),e(t.parentsel+"   .rapidAddImg").length>0&&e(t.parentsel+"   .rapidAddImg").bind("click",function(i){e(t.parentsel+" .fileImage").click()})},this.init()})}}(jQuery);